{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Registrar Accidente - Sistema de Gestión de Accidentes{% endblock %}

{% block extra_css %}
<style>
    .vehiculo-form {
        border: 1px solid #e3e6f0;
        border-radius: 0.35rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background-color: #f8f9fc;
    }
    
    .fallecido-form {
        background-color: #fff;
        margin-top: 0.5rem;
    }
    
    .required label:after {
        content: " *";
        color: red;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Registrar Accidente de Tránsito</h1>
        <a href="{% url 'lista_accidentes' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
    </div>
    
    <form method="post" enctype="multipart/form-data" id="accidenteForm">
        {% csrf_token %}
        
        <!-- Información Básica -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Información Básica del Accidente</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.numero_ipat|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.agente_responsable|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.fecha_accidente|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.hora_accidente|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.dias_establecidos_entrega|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.fecha_real_entrega|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.total_vehiculos_involucrados|as_crispy_field }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tipo de Accidente:</label>
                        <div class="form-check">
                            {{ form.con_heridos }}
                            <label class="form-check-label" for="{{ form.con_heridos.id_for_label }}">
                                Con Heridos
                            </label>
                        </div>
                        <div class="form-check">
                            {{ form.con_muertos }}
                            <label class="form-check-label" for="{{ form.con_muertos.id_for_label }}">
                                Con Muertos
                            </label>
                        </div>
                        <div class="form-check">
                            {{ form.con_danos_materiales }}
                            <label class="form-check-label" for="{{ form.con_danos_materiales.id_for_label }}">
                                Con Daños Materiales
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ubicación -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Ubicación y Detalles del Accidente</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        {{ form.via|as_crispy_field }}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.numero_via|as_crispy_field }}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.complemento1|as_crispy_field }}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.complemento2|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        {{ form.otra_informacion_direccion|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.area|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.zat|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="barrio_container">
                        {{ form.barrio|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row" id="centro_poblado_container" style="display: none;">
                    <div class="col-md-6 mb-3">
                        {{ form.centro_poblado_vereda|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.clase_accidente|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="otro_clase_accidente_container" style="display: none;">
                        {{ form.otro_clase_accidente|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.tipo_via|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row" id="choque_con_container">
                    <div class="col-md-4 mb-3">
                        {{ form.choque_con|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="objeto_fijo_container" style="display: none;">
                        {{ form.objeto_fijo|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="otro_objeto_fijo_container" style="display: none;">
                        {{ form.otro_objeto_fijo|as_crispy_field }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hipótesis -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Hipótesis del Accidente</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Hipótesis del Conductor</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor2|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor3|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor4|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Hipótesis del Vehículo</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_vehiculo1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_vehiculo2|as_crispy_field }}
                        </div>
                        
                        <h5 class="mt-4">Hipótesis de la Vía</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_via1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_via2|as_crispy_field }}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>Hipótesis del Peatón</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_peaton1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_peaton2|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3 mt-4">
                            {{ form.remitido_a|as_crispy_field }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.croquis_pdf|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vehículos Involucrados -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Vehículos Involucrados</h4>
                <small>Complete la información para cada vehículo involucrado en el accidente</small>
            </div>
            <div class="card-body">
                <div id="vehiculos_formset">
                    {{ vehiculo_formset.management_form }}
                    
                    {% for vehiculo_form in vehiculo_formset %}
                    <div class="vehiculo-form" id="vehiculo_{{ forloop.counter0 }}">
                        <h5 class="border-bottom pb-2">Vehículo #{{ forloop.counter }}</h5>
                        
                        {{ vehiculo_form.id }}
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.tipo_servicio|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.clase_vehiculo|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.genero_involucrado|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.rango_edad_involucrado|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.heridos|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.fallecidos|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.embriaguez_conductor|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3 embriaguez_grado_container" style="display: none;">
                                {{ vehiculo_form.grado_embriaguez|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.numero_heridos|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.numero_fallecidos|as_crispy_field }}
                            </div>
                            {% if forloop.counter > 1 %}
                            <div class="col-md-4 mb-3">
                                <button type="button" class="btn btn-danger mt-4 eliminar-vehiculo">
                                    <i class="fas fa-trash me-2"></i>Eliminar Vehículo
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="heridos_fallece_container" style="display: none;">
                            <h6 class="mt-3">Información de Heridos que Fallecen Después</h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido1_fallece_despues|as_crispy_field }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido2_fallece_despues|as_crispy_field }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido3_fallece_despues|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido4_fallece_despues|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="fallecidos_container" style="display: none;">
                            <h6 class="mt-4">Información de Fallecidos</h6>
                            <div class="fallecidos_forms">
                                <!-- Los formularios de fallecidos se generarán dinámicamente con JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Eliminar formulario -->
                        <div class="d-none">
                            {{ vehiculo_form.DELETE }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="button" id="agregar_vehiculo_btn" class="btn btn-success">
                            <i class="fas fa-plus-circle me-2"></i>Agregar Vehículo
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botones de acción -->
        <div class="row mt-4 mb-5">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save me-2"></i>Guardar Accidente
                </button>
                <a href="{% url 'lista_accidentes' %}" class="btn btn-secondary btn-lg ms-3">
                    <i class="fas fa-times me-2"></i>Cancelar
                </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos del DOM
        const areaSelect = document.getElementById('id_area');
        const barrioContainer = document.getElementById('barrio_container');
        const centroPobladoContainer = document.getElementById('centro_poblado_container');
        const claseAccidenteSelect = document.getElementById('id_clase_accidente');
        const otroClaseAccidenteContainer = document.getElementById('otro_clase_accidente_container');
        const choqueConSelect = document.getElementById('id_choque_con');
        const objetoFijoContainer = document.getElementById('objeto_fijo_container');
        const objetoFijoSelect = document.getElementById('id_objeto_fijo');
        const otroObjetoFijoContainer = document.getElementById('otro_objeto_fijo_container');
        const totalVehiculosInput = document.getElementById('id_total_vehiculos_involucrados');
        const agregarVehiculoBtn = document.getElementById('agregar_vehiculo_btn');
        
        // Formulario de vehículos
        const vehiculosFormset = document.getElementById('vehiculos_formset');
        const vehiculoForms = document.querySelectorAll('.vehiculo-form');
        
        // Contadores para el formset
        let formsetPrefix = 'vehiculo_set';
        let totalFormsInput = document.querySelector(`#id_${formsetPrefix}-TOTAL_FORMS`);
        let initialFormsInput = document.querySelector(`#id_${formsetPrefix}-INITIAL_FORMS`);
        let formCount = parseInt(totalFormsInput.value);
        
        // Plantilla para el formulario de fallecidos
        function getFallecidoFormTemplate(vehiculoIndex, fallecidoIndex) {
            return `
                <div class="fallecido-form border rounded p-3 mt-2">
                    <h6>Fallecido #${fallecidoIndex}</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fallecido_${vehiculoIndex}_${fallecidoIndex}_nombre" class="form-label">Nombre y Apellidos:</label>
                            <input type="text" class="form-control" id="fallecido_${vehiculoIndex}_${fallecidoIndex}_nombre" 
                                   name="fallecidos[${vehiculoIndex}][${fallecidoIndex}][nombre_apellidos]" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fallecido_${vehiculoIndex}_${fallecidoIndex}_direccion" class="form-label">Dirección:</label>
                            <input type="text" class="form-control" id="fallecido_${vehiculoIndex}_${fallecidoIndex}_direccion" 
                                   name="fallecidos[${vehiculoIndex}][${fallecidoIndex}][direccion]" required>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Función para manejar la visibilidad de campos según el área
        function handleAreaChange() {
            if (areaSelect.value === 'URBANA') {
                barrioContainer.style.display = 'block';
                centroPobladoContainer.style.display = 'none';
            } else if (areaSelect.value === 'RURAL') {
                barrioContainer.style.display = 'none';
                centroPobladoContainer.style.display = 'block';
            } else {
                barrioContainer.style.display = 'block';
                centroPobladoContainer.style.display = 'none';
            }
        }
        
        // Función para manejar la visibilidad de campos según la clase de accidente
        function handleClaseAccidenteChange() {
            if (claseAccidenteSelect.value === 'OTRO') {
                otroClaseAccidenteContainer.style.display = 'block';
            } else {
                otroClaseAccidenteContainer.style.display = 'none';
            }
        }
        
        // Función para manejar la visibilidad de campos según el tipo de choque
        function handleChoqueConChange() {
            if (choqueConSelect.value === 'OBJETO FIJO') {
                objetoFijoContainer.style.display = 'block';
            } else {
                objetoFijoContainer.style.display = 'none';
                otroObjetoFijoContainer.style.display = 'none';
            }
        }
        
        // Función para manejar la visibilidad de campos según el objeto fijo
        function handleObjetoFijoChange() {
            if (objetoFijoSelect.value === 'OTRO') {
                otroObjetoFijoContainer.style.display = 'block';
            } else {
                otroObjetoFijoContainer.style.display = 'none';
            }
        }
        
        // Función para inicializar eventos de embriaguez, heridos y fallecidos
        function initializeVehiculoEvents() {
            // Embriaguez
            document.querySelectorAll('[id^="id_vehiculo_set-"][id$="-embriaguez_conductor"]').forEach(select => {
                select.addEventListener('change', function() {
                    const formIndex = this.id.match(/\d+/)[0];
                    const gradoContainer = this.closest('.vehiculo-form').querySelector('.embriaguez_grado_container');
                    
                    if (this.value === 'SI') {
                        gradoContainer.style.display = 'block';
                    } else {
                        gradoContainer.style.display = 'none';
                    }
                });
                
                // Inicializar estado
                const formIndex = select.id.match(/\d+/)[0];
                const gradoContainer = select.closest('.vehiculo-form').querySelector('.embriaguez_grado_container');
                
                if (select.value === 'SI') {
                    gradoContainer.style.display = 'block';
                }
            });
            
            // Número de heridos
            document.querySelectorAll('[id^="id_vehiculo_set-"][id$="-numero_heridos"]').forEach(input => {
                input.addEventListener('change', function() {
                    const formIndex = this.id.match(/\d+/)[0];
                    const heridosContainer = this.closest('.vehiculo-form').querySelector('.heridos_fallece_container');
                    
                    if (parseInt(this.value) > 0) {
                        heridosContainer.style.display = 'block';
                    } else {
                        heridosContainer.style.display = 'none';
                    }
                });
                
                // Inicializar estado
                const formIndex = input.id.match(/\d+/)[0];
                const heridosContainer = input.closest('.vehiculo-form').querySelector('.heridos_fallece_container');
                
                if (parseInt(input.value) > 0) {
                    heridosContainer.style.display = 'block';
                }
            });
            
            // Número de fallecidos
            document.querySelectorAll('[id^="id_vehiculo_set-"][id$="-numero_fallecidos"]').forEach(input => {
                input.addEventListener('change', function() {
                    const formIndex = this.id.match(/\d+/)[0];
                    const fallecidosContainer = this.closest('.vehiculo-form').querySelector('.fallecidos_container');
                    const fallecidosForms = this.closest('.vehiculo-form').querySelector('.fallecidos_forms');
                    
                    if (parseInt(this.value) > 0) {
                        fallecidosContainer.style.display = 'block';
                        
                        // Limpiar formularios existentes
                        fallecidosForms.innerHTML = '';
                        
                        // Crear formularios para cada fallecido
                        for (let i = 1; i <= parseInt(this.value); i++) {
                            fallecidosForms.innerHTML += getFallecidoFormTemplate(formIndex, i);
                        }
                    } else {
                        fallecidosContainer.style.display = 'none';
                        fallecidosForms.innerHTML = '';
                    }
                });
                
                // Inicializar estado
                const formIndex = input.id.match(/\d+/)[0];
                const fallecidosContainer = input.closest('.vehiculo-form').querySelector('.fallecidos_container');
                const fallecidosForms = input.closest('.vehiculo-form').querySelector('.fallecidos_forms');
                
                if (parseInt(input.value) > 0) {
                    fallecidosContainer.style.display = 'block';
                    
                    // Crear formularios para cada fallecido
                    for (let i = 1; i <= parseInt(input.value); i++) {
                        fallecidosForms.innerHTML += getFallecidoFormTemplate(formIndex, i);
                    }
                }
            });
            
            // Botones para eliminar vehículos
            document.querySelectorAll('.eliminar-vehiculo').forEach(btn => {
                btn.addEventListener('click', function() {
                    const vehiculoForm = this.closest('.vehiculo-form');
                    const formIndex = vehiculoForm.id.replace('vehiculo_', '');
                    
                    // Marcar como eliminado
                    const deleteCheckbox = document.getElementById(`id_vehiculo_set-${formIndex}-DELETE`);
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                    }
                    
                    // Ocultar el formulario
                    vehiculoForm.style.display = 'none';
                    
                    // Actualizar el contador de vehículos
                    updateTotalVehiculos();
                });
            });
        }
        
        // Función para actualizar el total de vehículos
        function updateTotalVehiculos() {
            const visibleVehiculos = document.querySelectorAll('.vehiculo-form[style*="display: none"]').length;
            totalVehiculosInput.value = formCount - visibleVehiculos;
        }
        
        // Función para agregar un nuevo formulario de vehículo
        function addVehiculoForm() {
            // Verificar límite de 10 vehículos
            if (formCount >= 10) {
                alert('No se pueden agregar más de 10 vehículos.');
                return;
            }
            
            // Obtener el HTML del primer formulario como plantilla
            const firstForm = document.querySelector('.vehiculo-form');
            const newForm = firstForm.cloneNode(true);
            
            // Actualizar IDs y nombres
            newForm.id = `vehiculo_${formCount}`;
            newForm.innerHTML = newForm.innerHTML.replace(/-0-/g, `-${formCount}-`);
            newForm.innerHTML = newForm.innerHTML.replace(/_0_/g, `_${formCount}_`);
            
            // Limpiar valores
            newForm.querySelectorAll('input[type="text"], input[type="number"], select').forEach(input => {
                if (input.name.includes('DELETE')) {
                    input.checked = false;
                } else if (input.type === 'number') {
                    input.value = 0;
                } else {
                    input.value = '';
                }
            });
            
            // Actualizar título
            newForm.querySelector('h5').textContent = `Vehículo #${formCount + 1}`;
            
            // Agregar botón de eliminar
            if (!newForm.querySelector('.eliminar-vehiculo')) {
                const lastRow = newForm.querySelector('.row:nth-of-type(3)');
                const btnCol = document.createElement('div');
                btnCol.className = 'col-md-4 mb-3';
                btnCol.innerHTML = `
                    <button type="button" class="btn btn-danger mt-4 eliminar-vehiculo">
                        <i class="fas fa-trash me-2"></i>Eliminar Vehículo
                    </button>
                `;
                lastRow.appendChild(btnCol);
            }
            
            // Resetear contenedores específicos
            newForm.querySelector('.fallecidos_forms').innerHTML = '';
            newForm.querySelector('.fallecidos_container').style.display = 'none';
            newForm.querySelector('.heridos_fallece_container').style.display = 'none';
            newForm.querySelector('.embriaguez_grado_container').style.display = 'none';
            
            // Añadir el nuevo formulario
            vehiculosFormset.insertBefore(newForm, agregarVehiculoBtn.parentNode.parentNode.parentNode);
            
            // Incrementar contador y actualizar TOTAL_FORMS
            formCount++;
            totalFormsInput.value = formCount;
            
            // Actualizar total de vehículos
            totalVehiculosInput.value = formCount;
            
            // Inicializar eventos para el nuevo formulario
            initializeVehiculoEvents();
        }
        
        // Inicializar eventos
        areaSelect.addEventListener('change', handleAreaChange);
        claseAccidenteSelect.addEventListener('change', handleClaseAccidenteChange);
        choqueConSelect.addEventListener('change', handleChoqueConChange);
        objetoFijoSelect.addEventListener('change', handleObjetoFijoChange);
        agregarVehiculoBtn.addEventListener('click', addVehiculoForm);
        
        // Inicializar estados
        handleAreaChange();
        handleClaseAccidenteChange();
        handleChoqueConChange();
        handleObjetoFijoChange();
        initializeVehiculoEvents();
    });
</script>
{% endblock %}