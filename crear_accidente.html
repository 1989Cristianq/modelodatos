{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Registrar Accidente - Sistema de Gestión de Accidentes{% endblock %}

{% block extra_css %}
<style>
    .vehiculo-form {
        border: 1px solid #e3e6f0;
        border-radius: 0.35rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background-color: #f8f9fc;
    }
    
    .fallecido-form {
        background-color: #fff;
        margin-top: 0.5rem;
    }
    
    .required label:after {
        content: " *";
        color: red;
    }

    .info-box {
        background-color: #e8f4ff;
        border-left: 4px solid #4e73df;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 0.35rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Registrar Accidente de Tránsito</h1>
        <a href="{% url 'lista_accidentes' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
    </div>
    
    <form method="post" enctype="multipart/form-data" id="accidenteForm">
        {% csrf_token %}
        
        <!-- Usuario y Fecha de Registro (Campos automáticos) -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-primary text-white">
                <h4 class="m-0 font-weight-bold">Información de Registro</h4>
            </div>
            <div class="card-body">
                <div class="info-box">
                    <p class="mb-0"><i class="fas fa-info-circle mr-2"></i> Esta información se registra automáticamente al guardar el formulario.</p>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Usuario Registrante:</label>
                        <input type="text" class="form-control" value="{{ request.user.get_full_name }}" disabled>
                        {{ form.usuario.as_hidden }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha y Hora de Registro:</label>
                        <input type="text" class="form-control" value="{% now "d/m/Y H:i" %}" disabled>
                        {{ form.fecha_registro.as_hidden }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Información Básica -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Información Básica del Accidente</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.numero_ipat|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.agente_responsable|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.fecha_accidente|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.hora_accidente|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.dias_establecidos_entrega|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.fecha_real_entrega|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.total_vehiculos_involucrados|as_crispy_field }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tipo de Accidente:</label>
                        <div class="form-check">
                            {{ form.con_heridos }}
                            <label class="form-check-label" for="{{ form.con_heridos.id_for_label }}">
                                Con Heridos
                            </label>
                        </div>
                        <div class="form-check">
                            {{ form.con_muertos }}
                            <label class="form-check-label" for="{{ form.con_muertos.id_for_label }}">
                                Con Muertos
                            </label>
                        </div>
                        <div class="form-check">
                            {{ form.con_danos_materiales }}
                            <label class="form-check-label" for="{{ form.con_danos_materiales.id_for_label }}">
                                Con Daños Materiales
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ubicación -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Ubicación y Detalles del Accidente</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        {{ form.via|as_crispy_field }}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.numero_via|as_crispy_field }}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.complemento1|as_crispy_field }}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.complemento2|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        {{ form.otra_informacion_direccion|as_crispy_field }}
                    </div>
                </div>
                
     <!--            <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.area|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.zat|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="barrio_container">
                        {{ form.barrio|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row" id="centro_poblado_container" style="display: none;">
                    <div class="col-md-6 mb-3">
                        {{ form.centro_poblado_vereda|as_crispy_field }}
                    </div>
                </div> -->
            <div class="row">
    <div class="col-md-4 mb-3">
        {{ form.area|as_crispy_field }}
    </div>
    <div class="col-md-4 mb-3" id="zat_container">
        <div class="form-group required">
            <label for="id_zat" class="form-label">ZAT</label>
            <select name="zat" class="select form-control" required id="id_zat">
                <option value="">---------</option>
            </select>
            <div class="invalid-feedback">Este campo es obligatorio.</div>
        </div>
    </div>
    <div class="col-md-4 mb-3" id="barrio_container">
        <div class="form-group required">
            <label for="id_barrio" class="form-label">Barrio</label>
            <select name="barrio" class="select form-control" required id="id_barrio">
                <option value="">---------</option>
            </select>
            <div class="invalid-feedback">Este campo es obligatorio.</div>
        </div>
    </div>
</div>

<div class="row" id="centro_poblado_container" style="display: none;">
    <div class="col-md-6 mb-3">
        {{ form.centro_poblado_vereda|as_crispy_field }}
    </div>
</div>    
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.clase_accidente|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="otro_clase_accidente_container" style="display: none;">
                        {{ form.otro_clase_accidente|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.tipo_via|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row" id="choque_con_container">
                    <div class="col-md-4 mb-3">
                        {{ form.choque_con|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="objeto_fijo_container" style="display: none;">
                        {{ form.objeto_fijo|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="otro_objeto_fijo_container" style="display: none;">
                        {{ form.otro_objeto_fijo|as_crispy_field }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hipótesis -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Hipótesis del Accidente</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Hipótesis del Conductor</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor2|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor3|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor4|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Hipótesis del Vehículo</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_vehiculo1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_vehiculo2|as_crispy_field }}
                        </div>
                        
                        <h5 class="mt-4">Hipótesis de la Vía</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_via1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_via2|as_crispy_field }}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>Hipótesis del Peatón</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_peaton1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_peaton2|as_crispy_field }}
                        </div>
                        
                        <!-- Si quieres añadir hipótesis del pasajero, añádelas aquí -->
                        {% if form.hipotesis_pasajero1 %}
                        <h5 class="mt-4">Hipótesis del Pasajero</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_pasajero1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_pasajero2|as_crispy_field }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3 mt-4">
                            {{ form.remitido_a|as_crispy_field }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.croquis_pdf|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vehículos Involucrados -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Vehículos Involucrados</h4>
                <small>Complete la información para cada vehículo involucrado en el accidente</small>
            </div>
            <div class="card-body">
                <div id="vehiculos_formset">
                    {{ vehiculo_formset.management_form }}
                    
                    {% for vehiculo_form in vehiculo_formset %}
                    <div class="vehiculo-form" id="vehiculo_{{ forloop.counter0 }}">
                        <h5 class="border-bottom pb-2">Vehículo #{{ forloop.counter }}</h5>
                        
                        {{ vehiculo_form.id }}
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.tipo_servicio|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.clase_vehiculo|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.genero_involucrado|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.rango_edad_involucrado|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.heridos|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.fallecidos|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.embriaguez_conductor|as_crispy_field }}
                                <div class="embriaguez_grado_container" style="display: none; margin-top: 10px;">
                                    {{ vehiculo_form.grado_embriaguez|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.numero_heridos|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.numero_fallecidos|as_crispy_field }}
                            </div>
                            {% if forloop.counter > 1 %}
                            <div class="col-md-4 mb-3">
                                <button type="button" class="btn btn-danger mt-4 eliminar-vehiculo">
                                    <i class="fas fa-trash me-2"></i>Eliminar Vehículo
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="heridos_fallece_container" style="display: none;">
                            <h6 class="mt-3">Información de Heridos que Fallecen Después</h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido1_fallece_despues|as_crispy_field }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido2_fallece_despues|as_crispy_field }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido3_fallece_despues|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido4_fallece_despues|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="fallecidos_container" style="display: none;">
                            <h6 class="mt-4">Información de Fallecidos</h6>
                            <div class="fallecidos_forms">
                                <!-- Los formularios de fallecidos se generarán dinámicamente con JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Eliminar formulario -->
                        <div class="d-none">
                            {{ vehiculo_form.DELETE }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="button" id="agregar_vehiculo_btn" class="btn btn-success">
                            <i class="fas fa-plus-circle me-2"></i>Agregar Vehículo
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botones de acción -->
        <div class="row mt-4 mb-5">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save me-2"></i>Guardar Accidente
                </button>
                <a href="{% url 'lista_accidentes' %}" class="btn btn-secondary btn-lg ms-3">
                    <i class="fas fa-times me-2"></i>Cancelar
                </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando formulario (versión optimizada)');
    
    // Esperar un breve momento para asegurar la carga completa del DOM
    setTimeout(function() {
        // ===========================================================
        // 1. FUNCIÓN DE GESTIÓN DIRECTA DE CAMPOS
        // ===========================================================
        function mostrarOcultarContenedor(selector, condicion) {
            const contenedores = document.querySelectorAll(selector);
            contenedores.forEach(contenedor => {
                if (contenedor) {
                    contenedor.style.display = condicion ? 'block' : 'none';
                    console.log(`${selector}: ${condicion ? 'Mostrando' : 'Ocultando'}`);
                }
            });
        }
        
    // ===========================================================
// 2. MANEJO DE ÁREA (URBANA/RURAL) Y CARGA DE ZAT Y BARRIOS
// ===========================================================
const areaSelect = document.getElementById('id_area');
const zatSelect = document.getElementById('id_zat');
const barrioSelect = document.getElementById('id_barrio');

// Cargar los ZATs disponibles
function cargarZATs() {
    console.log('Cargando ZATs...');
    
    // Limpiar opciones actuales
    zatSelect.innerHTML = '<option value="">---------</option>';
    
    // Lista de ZATs (basada en tu imagen)
    const zats = [
        {id: 1, nombre: 'ZAT 1'},
        {id: 2, nombre: 'ZAT 2'},
        {id: 3, nombre: 'ZAT 3'},
        {id: 4, nombre: 'ZAT 4'},
        {id: 5, nombre: 'ZAT 5'},
        {id: 6, nombre: 'ZAT 6'},
        {id: 7, nombre: 'ZAT 7'},
        {id: 8, nombre: 'ZAT 8'},
        {id: 9, nombre: 'ZAT 9'},
        {id: 10, nombre: 'ZAT 10'},
        {id: 11, nombre: 'ZAT 11'},
        {id: 12, nombre: 'ZAT 12'}
    ];
    
    // Poblar el select de ZATs
    zats.forEach(zat => {
        const option = document.createElement('option');
        option.value = zat.id;
        option.textContent = zat.nombre;
        zatSelect.appendChild(option);
    });
}

// Función para cargar los barrios según el ZAT seleccionado
function cargarBarriosPorZAT(zatId) {
    console.log(`Cargando barrios para ZAT ${zatId}...`);
    
    // Limpiar opciones actuales
    barrioSelect.innerHTML = '<option value="">---------</option>';
    
    // Si no hay ZAT seleccionado, no hacemos nada más
    if (!zatId) return;
    
    // Esta sería una llamada a una API en producción
    // Aquí simulamos los datos para demostración
    // En un entorno real, deberías hacer una petición AJAX al servidor
    
    // Ejemplo de estructura de datos de barrios por ZAT
    const barriosPorZAT = {
        1: [
            {id: 1, nombre: 'Centro'},
            {id: 2, nombre: 'La Esmeralda'},
            {id: 3, nombre: 'San Francisco'}
        ],
        2: [
            {id: 4, nombre: 'El Jardín'},
            {id: 5, nombre: 'Los Pinos'},
            {id: 6, nombre: 'Villa Nueva'}
        ],
        3: [
            {id: 7, nombre: 'La Esperanza'},
            {id: 8, nombre: 'Bello Horizonte'},
            {id: 9, nombre: 'El Prado'}
        ],
        // ... otros ZATs con sus respectivos barrios
    };
    
    // Obtener los barrios para el ZAT seleccionado
    const barrios = barriosPorZAT[zatId] || [];
    
    // Poblar el select de barrios
    barrios.forEach(barrio => {
        const option = document.createElement('option');
        option.value = barrio.id;
        option.textContent = barrio.nombre;
        barrioSelect.appendChild(option);
    });
}

// Manejar cambio de área (urbana/rural)
if (areaSelect) {
    function actualizarArea() {
        const esRural = areaSelect.value === 'RURAL';
        
        // Mostrar/ocultar contenedores según el área seleccionada
        document.getElementById('zat_container').style.display = esRural ? 'none' : 'block';
        document.getElementById('barrio_container').style.display = esRural ? 'none' : 'block';
        document.getElementById('centro_poblado_container').style.display = esRural ? 'block' : 'none';
        
        // Actualizar atributos required según el área
        zatSelect.required = !esRural;
        barrioSelect.required = !esRural;
        
        if (!esRural && !zatSelect.options.length) {
            cargarZATs();
        }
    }
    
    areaSelect.addEventListener('change', actualizarArea);
    actualizarArea(); // Ejecutar inicialmente
}

// Manejar cambio de ZAT para cargar barrios correspondientes
if (zatSelect) {
    zatSelect.addEventListener('change', function() {
        cargarBarriosPorZAT(this.value);
    });
    
    // Cargar ZATs inicialmente si el área no es rural
    if (areaSelect && areaSelect.value !== 'RURAL') {
        cargarZATs();
        
        // Si ya hay un ZAT seleccionado, cargar sus barrios
        if (zatSelect.value) {
            cargarBarriosPorZAT(zatSelect.value);
        }
    }
}
        
        // ===========================================================
        // 3. MANEJO DE CLASE DE ACCIDENTE
        // ===========================================================
        const claseAccidenteSelect = document.getElementById('id_clase_accidente');
        if (claseAccidenteSelect) {
            function actualizarClaseAccidente() {
                const otroContainer = document.getElementById('otro_clase_accidente_container');
                if (otroContainer) {
                    otroContainer.style.display = claseAccidenteSelect.value === 'OTRO' ? 'block' : 'none';
                }
            }
            
            claseAccidenteSelect.addEventListener('change', actualizarClaseAccidente);
            actualizarClaseAccidente(); // Ejecutar inicialmente
        }
        
        // ===========================================================
        // 4. MANEJO DE CHOQUE CON OBJETO FIJO
        // ===========================================================
        const choqueConSelect = document.getElementById('id_choque_con');
        const objetoFijoSelect = document.getElementById('id_objeto_fijo');
        
        if (choqueConSelect) {
            function actualizarChoqueCon() {
                const objetoFijoContainer = document.getElementById('objeto_fijo_container');
                const esObjetoFijo = choqueConSelect.value === 'OBJETO FIJO';
                
                if (objetoFijoContainer) {
                    objetoFijoContainer.style.display = esObjetoFijo ? 'block' : 'none';
                }
                
                const otroObjetoFijoContainer = document.getElementById('otro_objeto_fijo_container');
                if (!esObjetoFijo && otroObjetoFijoContainer) {
                    otroObjetoFijoContainer.style.display = 'none';
                } else if (esObjetoFijo && objetoFijoSelect) {
                    actualizarObjetoFijo();
                }
            }
            
            choqueConSelect.addEventListener('change', actualizarChoqueCon);
            actualizarChoqueCon(); // Ejecutar inicialmente
        }
        
        if (objetoFijoSelect) {
            function actualizarObjetoFijo() {
                const otroObjetoFijoContainer = document.getElementById('otro_objeto_fijo_container');
                if (otroObjetoFijoContainer) {
                    otroObjetoFijoContainer.style.display = objetoFijoSelect.value === 'OTRO' ? 'block' : 'none';
                }
            }
            
            objetoFijoSelect.addEventListener('change', actualizarObjetoFijo);
            actualizarObjetoFijo(); // Ejecutar inicialmente
        }
        
        // ===========================================================
        // 5. FUNCIONES DE INICIALIZACIÓN Y GESTIÓN DE VEHÍCULOS
        // ===========================================================
        
        // Obtener el número del formulario a partir del ID
        function obtenerIndiceFormulario(input) {
            const match = input.id.match(/vehiculo_set-(\d+)/);
            return match ? match[1] : '0';
        }
        
        // Plantilla para el formulario de fallecidos
        function getFallecidoFormTemplate(vehiculoIndex, fallecidoIndex) {
            return `
                <div class="fallecido-form border rounded p-3 mt-2">
                    <h6>Fallecido #${fallecidoIndex}</h6>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="fallecido_${vehiculoIndex}_${fallecidoIndex}_nombre" class="form-label">Nombre y Apellidos:</label>
                            <input type="text" class="form-control" id="fallecido_${vehiculoIndex}_${fallecidoIndex}_nombre" 
                                   name="fallecidos[${vehiculoIndex}][${fallecidoIndex}][nombre_apellidos]" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="fallecido_${vehiculoIndex}_${fallecidoIndex}_direccion" class="form-label">Dirección:</label>
                            <input type="text" class="form-control" id="fallecido_${vehiculoIndex}_${fallecidoIndex}_direccion" 
                                   name="fallecidos[${vehiculoIndex}][${fallecidoIndex}][direccion]" required>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Para actualizar la numeración de vehículos visibles
        function renumerarVehiculos() {
            const vehiculos = document.querySelectorAll('.vehiculo-form:not([style*="display: none"])');
            vehiculos.forEach((vehiculo, index) => {
                const titulo = vehiculo.querySelector('h5');
                if (titulo) titulo.textContent = `Vehículo #${index + 1}`;
            });
        }
        
        // Para actualizar el contador total de vehículos
        function actualizarTotalVehiculos() {
            const totalInput = document.getElementById('id_total_vehiculos_involucrados');
            if (totalInput) {
                const cantidad = document.querySelectorAll('.vehiculo-form:not([style*="display: none"])').length;
                totalInput.value = cantidad;
            }
        }
        
        // Para inicializar todos los eventos de un formulario de vehículo específico
        function inicializarFormularioVehiculo(formulario) {
            console.log(`Inicializando eventos para ${formulario.id}`);
            
            // 1. EMBRIAGUEZ DEL CONDUCTOR
            const embriaguezSelect = formulario.querySelector('[id$="-embriaguez_conductor"]');
            if (embriaguezSelect) {
                console.log(`Encontrado selector de embriaguez: ${embriaguezSelect.id} = "${embriaguezSelect.value}"`);
                
                // Importante: Movemos el contenedor de grado al lugar correcto si aún no está ahí
                const gradoContainer = formulario.querySelector('.embriaguez_grado_container');
                if (!gradoContainer) {
                    console.error(`No se encontró el contenedor de grado para ${embriaguezSelect.id}`);
                } else {
                    function actualizarEstadoEmbriaguez() {
                        console.log(`Actualizando embriaguez para ${embriaguezSelect.id} = "${embriaguezSelect.value}"`);
                        // Normaliza el valor para manejar acentos y mayúsculas
                        let valor = (embriaguezSelect.value || '').toUpperCase();
                        valor = valor.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                        const mostrarGrado = (valor === 'SI');
                        
                        // Forzar estilo inline para mayor prioridad
                        gradoContainer.style.cssText = mostrarGrado ? 'display: block !important;' : 'display: none !important;';
                        console.log(`Grado de embriaguez: ${mostrarGrado ? 'Visible' : 'Oculto'}`);
                    }
                    
                    // Quitar eventos previos y añadir uno nuevo
                    embriaguezSelect.removeEventListener('change', actualizarEstadoEmbriaguez);
                    embriaguezSelect.addEventListener('change', actualizarEstadoEmbriaguez);
                    
                    // Ejecutar inmediatamente
                    actualizarEstadoEmbriaguez();
                }
            } else {
                console.error(`No se encontró selector de embriaguez en ${formulario.id}`);
            }
            
            // 2. NÚMERO DE HERIDOS
            const numeroHeridosInput = formulario.querySelector('[id$="-numero_heridos"]');
            if (numeroHeridosInput) {
                console.log(`Encontrado input de heridos: ${numeroHeridosInput.id} = "${numeroHeridosInput.value}"`);
                
                const heridosFalleceContainer = formulario.querySelector('.heridos_fallece_container');
                if (!heridosFalleceContainer) {
                    console.error(`No se encontró el contenedor de heridos que fallecen para ${numeroHeridosInput.id}`);
                } else {
                    function actualizarEstadoHeridos() {
                        console.log(`Actualizando heridos para ${numeroHeridosInput.id} = "${numeroHeridosInput.value}"`);
                        const cantidad = parseInt(numeroHeridosInput.value) || 0;
                        const mostrarInfo = cantidad > 0;
                        
                        // Forzar estilo inline para mayor prioridad
                        heridosFalleceContainer.style.cssText = mostrarInfo ? 'display: block !important;' : 'display: none !important;';
                        console.log(`Heridos que fallecen: ${mostrarInfo ? 'Visible' : 'Oculto'}`);
                    }
                    
                    // Quitar eventos previos y añadir nuevos para capturar cualquier cambio
                    numeroHeridosInput.removeEventListener('change', actualizarEstadoHeridos);
                    numeroHeridosInput.removeEventListener('input', actualizarEstadoHeridos);
                    numeroHeridosInput.addEventListener('change', actualizarEstadoHeridos);
                    numeroHeridosInput.addEventListener('input', actualizarEstadoHeridos);
                    
                    // Ejecutar inmediatamente
                    actualizarEstadoHeridos();
                }
            } else {
                console.error(`No se encontró input de número de heridos en ${formulario.id}`);
            }
            
            // 3. NÚMERO DE FALLECIDOS
            const numeroFallecidosInput = formulario.querySelector('[id$="-numero_fallecidos"]');
            if (numeroFallecidosInput) {
                console.log(`Encontrado input de fallecidos: ${numeroFallecidosInput.id} = "${numeroFallecidosInput.value}"`);
                
                const fallecidosContainer = formulario.querySelector('.fallecidos_container');
                const fallecidosForms = formulario.querySelector('.fallecidos_forms');
                
                if (!fallecidosContainer || !fallecidosForms) {
                    console.error(`No se encontró el contenedor de fallecidos para ${numeroFallecidosInput.id}`);
                } else {
                    function actualizarEstadoFallecidos() {
                        console.log(`Actualizando fallecidos para ${numeroFallecidosInput.id} = "${numeroFallecidosInput.value}"`);
                        const cantidad = parseInt(numeroFallecidosInput.value) || 0;
                        const mostrarInfo = cantidad > 0;
                        
                        // Forzar estilo inline para mayor prioridad
                        fallecidosContainer.style.cssText = mostrarInfo ? 'display: block !important;' : 'display: none !important;';
                        
                        // Si hay fallecidos, generar sus formularios
                        if (mostrarInfo) {
                            fallecidosForms.innerHTML = '';
                            const vehiculoIndex = obtenerIndiceFormulario(numeroFallecidosInput);
                            
                            for (let i = 1; i <= cantidad; i++) {
                                fallecidosForms.innerHTML += getFallecidoFormTemplate(vehiculoIndex, i);
                            }
                        }
                        
                        console.log(`Información de fallecidos: ${mostrarInfo ? 'Visible' : 'Oculto'}`);
                    }
                    
                    // Quitar eventos previos y añadir nuevos para capturar cualquier cambio
                    numeroFallecidosInput.removeEventListener('change', actualizarEstadoFallecidos);
                    numeroFallecidosInput.removeEventListener('input', actualizarEstadoFallecidos);
                    numeroFallecidosInput.addEventListener('change', actualizarEstadoFallecidos);
                    numeroFallecidosInput.addEventListener('input', actualizarEstadoFallecidos);
                    
                    // Ejecutar inmediatamente
                    actualizarEstadoFallecidos();
                }
            } else {
                console.error(`No se encontró input de número de fallecidos en ${formulario.id}`);
            }
            
            // 4. BOTÓN ELIMINAR VEHÍCULO
            const botonEliminar = formulario.querySelector('.eliminar-vehiculo');
            if (botonEliminar) {
                console.log(`Encontrado botón eliminar en ${formulario.id}`);
                
                botonEliminar.addEventListener('click', function() {
                    console.log(`Eliminando ${formulario.id}`);
                    const formIndex = formulario.id.replace('vehiculo_', '');
                    
                    // Marcar como eliminado en el checkbox DELETE
                    const deleteCheckbox = document.getElementById(`id_vehiculo_set-${formIndex}-DELETE`);
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                        console.log(`Marcado para eliminar: vehiculo_${formIndex}`);
                    } else {
                        console.error(`No se encontró checkbox DELETE para vehiculo_${formIndex}`);
                    }
                    
                    // Ocultar el formulario
                    formulario.style.display = 'none';
                    console.log(`Ocultado: vehiculo_${formIndex}`);
                    
                    // Actualizar contador y numeración
                    actualizarTotalVehiculos();
                    renumerarVehiculos();
                });
            } else {
                console.log(`No se encontró botón eliminar en ${formulario.id} (posiblemente es el primer vehículo)`);
            }
        }
        
        // Inicializar todos los formularios de vehículos existentes
        console.log('Inicializando todos los formularios de vehículos');
        document.querySelectorAll('.vehiculo-form').forEach(formulario => {
            inicializarFormularioVehiculo(formulario);
        });
        
        // Botón agregar vehículo
        const agregarBtn = document.getElementById('agregar_vehiculo_btn');
        if (agregarBtn) {
            console.log('Configurando botón Agregar Vehículo');
            
            agregarBtn.addEventListener('click', function() {
                console.log('Botón Agregar Vehículo clickeado');
                
                // 1. Encontrar contenedor de formularios y gestor de formularios
                const formsetContainer = document.getElementById('vehiculos_formset');
                const totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');
                
                if (!formsetContainer || !totalFormsInput) {
                    console.error('No se encontraron elementos esenciales para agregar vehículo');
                    return;
                }
                
                // 2. Verificar límite
                const visibleCount = document.querySelectorAll('.vehiculo-form:not([style*="display: none"])').length;
                if (visibleCount >= 10) {
                    alert('No se pueden agregar más de 10 vehículos.');
                    return;
                }
                
                // 3. Obtener plantilla base
                const firstForm = document.querySelector('.vehiculo-form');
                if (!firstForm) {
                    console.error('No se encontró formulario base para clonar');
                    return;
                }
                
                // 4. Calcular nuevo índice y clonar
                const formCount = parseInt(totalFormsInput.value);
                console.log(`Creando vehículo con índice ${formCount}`);
                
                const newForm = firstForm.cloneNode(true);
                newForm.id = `vehiculo_${formCount}`;
                
                // 5. Actualizar índices
                newForm.innerHTML = newForm.innerHTML
                    .replace(/vehiculo_set-0-/g, `vehiculo_set-${formCount}-`)
                    .replace(/id_vehiculo_set-0-/g, `id_vehiculo_set-${formCount}-`);
                
                // 6. Actualizar título
                const title = newForm.querySelector('h5');
                if (title) title.textContent = `Vehículo #${visibleCount + 1}`;
                
                // 7. Limpiar valores
                newForm.querySelectorAll('input, select, textarea').forEach(field => {
                    if (field.type === 'checkbox') {
                        field.checked = false;
                    } else if (field.type === 'number') {
                        field.value = '0';
                    } else if (field.tagName === 'SELECT') {
                        field.selectedIndex = 0;
                    } else {
                        field.value = '';
                    }
                });
                
                // 8. Ocultar contenedores específicos
                newForm.querySelectorAll('.fallecidos_container, .heridos_fallece_container, .embriaguez_grado_container').forEach(container => {
                    container.style.display = 'none';
                });
                
                // 9. Limpiar formularios de fallecidos
                const fallecidosForms = newForm.querySelector('.fallecidos_forms');
                if (fallecidosForms) fallecidosForms.innerHTML = '';
                
                // 10. Asegurar que tiene botón eliminar
                if (!newForm.querySelector('.eliminar-vehiculo')) {
                    console.log('Añadiendo botón eliminar a nuevo vehículo');
                    const lastRow = newForm.querySelector('.row:nth-of-type(4)') || newForm.querySelector('.row:last-of-type');
                    if (lastRow) {
                        const btnCol = document.createElement('div');
                        btnCol.className = 'col-md-4 mb-3';
                        btnCol.innerHTML = `
                            <button type="button" class="btn btn-danger mt-4 eliminar-vehiculo">
                                <i class="fas fa-trash me-2"></i>Eliminar Vehículo
                            </button>
                        `;
                        lastRow.appendChild(btnCol);
                    }
                }
                
                // 11. Añadir al DOM
                formsetContainer.appendChild(newForm);
                
                // 12. Actualizar contadores
                totalFormsInput.value = formCount + 1;
                actualizarTotalVehiculos();
                
                // 13. Inicializar eventos
                inicializarFormularioVehiculo(newForm);
                
                // 14. Renumerar vehículos
                renumerarVehiculos();
                
                console.log(`Vehículo #${visibleCount + 1} agregado correctamente`);
            });
        } else {
            console.error('No se encontró el botón Agregar Vehículo');
        }
        
        console.log('Inicialización completa');
    }, 200); // Un pequeño retraso para asegurar que todo esté listo
});
</script>
{% endblock %}