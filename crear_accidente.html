{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Registrar Accidente - Sistema de Gestión de Accidentes{% endblock %}

{% block extra_css %}
<style>
    .vehiculo-form {
        border: 1px solid #e3e6f0;
        border-radius: 0.35rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        background-color: #f8f9fc;
    }
    
    .fallecido-form {
        background-color: #fff;
        margin-top: 0.5rem;
    }
    
    .required label:after {
        content: " *";
        color: red;
    }

    .info-box {
        background-color: #e8f4ff;
        border-left: 4px solid #4e73df;
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 0.35rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">Registrar Accidente de Tránsito</h1>
        <a href="{% url 'lista_accidentes' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>Volver
        </a>
    </div>
    
    <form method="post" enctype="multipart/form-data" id="accidenteForm">
        {% csrf_token %}
        
        <!-- Usuario y Fecha de Registro (Campos automáticos) -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-primary text-white">
                <h4 class="m-0 font-weight-bold">Información de Registro</h4>
            </div>
            <div class="card-body">
                <div class="info-box">
                    <p class="mb-0"><i class="fas fa-info-circle mr-2"></i> Esta información se registra automáticamente al guardar el formulario.</p>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Usuario Registrante:</label>
                        <input type="text" class="form-control" value="{{ request.user.get_full_name }}" disabled>
                        {{ form.usuario.as_hidden }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha y Hora de Registro:</label>
                        <input type="text" class="form-control" value="{% now "d/m/Y H:i" %}" disabled>
                        {{ form.fecha_registro.as_hidden }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Información Básica -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Información Básica del Accidente</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.numero_ipat|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.agente_responsable|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.fecha_accidente|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.hora_accidente|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.dias_establecidos_entrega|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.fecha_real_entrega|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        {{ form.total_vehiculos_involucrados|as_crispy_field }}
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tipo de Accidente:</label>
                        <div class="form-check">
                            {{ form.con_heridos }}
                            <label class="form-check-label" for="{{ form.con_heridos.id_for_label }}">
                                Con Heridos
                            </label>
                        </div>
                        <div class="form-check">
                            {{ form.con_muertos }}
                            <label class="form-check-label" for="{{ form.con_muertos.id_for_label }}">
                                Con Muertos
                            </label>
                        </div>
                        <div class="form-check">
                            {{ form.con_danos_materiales }}
                            <label class="form-check-label" for="{{ form.con_danos_materiales.id_for_label }}">
                                Con Daños Materiales
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Ubicación -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Ubicación y Detalles del Accidente</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        {{ form.via|as_crispy_field }}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.numero_via|as_crispy_field }}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.complemento1|as_crispy_field }}
                    </div>
                    <div class="col-md-3 mb-3">
                        {{ form.complemento2|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-12 mb-3">
                        {{ form.otra_informacion_direccion|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.area|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.zat|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="barrio_container">
                        {{ form.barrio|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row" id="centro_poblado_container" style="display: none;">
                    <div class="col-md-6 mb-3">
                        {{ form.centro_poblado_vereda|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-4 mb-3">
                        {{ form.clase_accidente|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="otro_clase_accidente_container" style="display: none;">
                        {{ form.otro_clase_accidente|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3">
                        {{ form.tipo_via|as_crispy_field }}
                    </div>
                </div>
                
                <div class="row" id="choque_con_container">
                    <div class="col-md-4 mb-3">
                        {{ form.choque_con|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="objeto_fijo_container" style="display: none;">
                        {{ form.objeto_fijo|as_crispy_field }}
                    </div>
                    <div class="col-md-4 mb-3" id="otro_objeto_fijo_container" style="display: none;">
                        {{ form.otro_objeto_fijo|as_crispy_field }}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Hipótesis -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Hipótesis del Accidente</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Hipótesis del Conductor</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor2|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor3|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_conductor4|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <h5>Hipótesis del Vehículo</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_vehiculo1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_vehiculo2|as_crispy_field }}
                        </div>
                        
                        <h5 class="mt-4">Hipótesis de la Vía</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_via1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_via2|as_crispy_field }}
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>Hipótesis del Peatón</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_peaton1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_peaton2|as_crispy_field }}
                        </div>
                        
                        <!-- Si quieres añadir hipótesis del pasajero, añádelas aquí -->
                        {% if form.hipotesis_pasajero1 %}
                        <h5 class="mt-4">Hipótesis del Pasajero</h5>
                        <div class="mb-3">
                            {{ form.hipotesis_pasajero1|as_crispy_field }}
                        </div>
                        <div class="mb-3">
                            {{ form.hipotesis_pasajero2|as_crispy_field }}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3 mt-4">
                            {{ form.remitido_a|as_crispy_field }}
                        </div>
                        
                        <div class="mb-3">
                            {{ form.croquis_pdf|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Vehículos Involucrados -->
        <div class="card shadow mb-4">
            <div class="card-header py-3 bg-success text-white">
                <h4 class="m-0 font-weight-bold">Vehículos Involucrados</h4>
                <small>Complete la información para cada vehículo involucrado en el accidente</small>
            </div>
            <div class="card-body">
                <div id="vehiculos_formset">
                    {{ vehiculo_formset.management_form }}
                    
                    {% for vehiculo_form in vehiculo_formset %}
                    <div class="vehiculo-form" id="vehiculo_{{ forloop.counter0 }}">
                        <h5 class="border-bottom pb-2">Vehículo #{{ forloop.counter }}</h5>
                        
                        {{ vehiculo_form.id }}
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.tipo_servicio|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.clase_vehiculo|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.genero_involucrado|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.rango_edad_involucrado|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.heridos|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.fallecidos|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.embriaguez_conductor|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3 embriaguez_grado_container" style="display: none;">
                                {{ vehiculo_form.grado_embriaguez|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.numero_heridos|as_crispy_field }}
                            </div>
                            <div class="col-md-4 mb-3">
                                {{ vehiculo_form.numero_fallecidos|as_crispy_field }}
                            </div>
                            {% if forloop.counter > 1 %}
                            <div class="col-md-4 mb-3">
                                <button type="button" class="btn btn-danger mt-4 eliminar-vehiculo">
                                    <i class="fas fa-trash me-2"></i>Eliminar Vehículo
                                </button>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="heridos_fallece_container" style="display: none;">
                            <h6 class="mt-3">Información de Heridos que Fallecen Después</h6>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido1_fallece_despues|as_crispy_field }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido2_fallece_despues|as_crispy_field }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido3_fallece_despues|as_crispy_field }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    {{ vehiculo_form.herido4_fallece_despues|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="fallecidos_container" style="display: none;">
                            <h6 class="mt-4">Información de Fallecidos</h6>
                            <div class="fallecidos_forms">
                                <!-- Los formularios de fallecidos se generarán dinámicamente con JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Eliminar formulario -->
                        <div class="d-none">
                            {{ vehiculo_form.DELETE }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div class="row mt-4">
                    <div class="col-12">
                        <button type="button" id="agregar_vehiculo_btn" class="btn btn-success">
                            <i class="fas fa-plus-circle me-2"></i>Agregar Vehículo
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botones de acción -->
        <div class="row mt-4 mb-5">
            <div class="col-12 text-center">
                <button type="submit" class="btn btn-primary btn-lg">
                    <i class="fas fa-save me-2"></i>Guardar Accidente
                </button>
                <a href="{% url 'lista_accidentes' %}" class="btn btn-secondary btn-lg ms-3">
                    <i class="fas fa-times me-2"></i>Cancelar
                </a>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando formulario (versión directa)');
    
    // ===========================================================
    // 1. FUNCIÓN DE GESTIÓN DIRECTA DE CAMPOS
    // ===========================================================
    function mostrarOcultarContenedor(selector, condicion) {
        const contenedores = document.querySelectorAll(selector);
        contenedores.forEach(contenedor => {
            contenedor.style.display = condicion ? 'block' : 'none';
            console.log(`${selector}: ${condicion ? 'Mostrando' : 'Ocultando'}`);
        });
    }
    
    // ===========================================================
    // 2. MANEJO DE ÁREA (URBANA/RURAL)
    // ===========================================================
    const areaSelect = document.getElementById('id_area');
    if (areaSelect) {
        function actualizarArea() {
            const esRural = areaSelect.value === 'RURAL';
            mostrarOcultarContenedor('#barrio_container', !esRural);
            mostrarOcultarContenedor('#centro_poblado_container', esRural);
            
            // Buscar contenedor ZAT de manera directa
            const zatLabel = Array.from(document.querySelectorAll('label')).find(
                label => label.textContent.trim() === 'ZAT' || label.textContent.trim() === 'ZAT:'
            );
            if (zatLabel) {
                const zatContainer = zatLabel.closest('.col-md-4, .form-group');
                if (zatContainer) zatContainer.style.display = esRural ? 'none' : 'block';
            }
        }
        
        areaSelect.addEventListener('change', actualizarArea);
        actualizarArea();
    }
    
    // ===========================================================
    // 3. MANEJO DE CLASE DE ACCIDENTE
    // ===========================================================
    const claseAccidenteSelect = document.getElementById('id_clase_accidente');
    if (claseAccidenteSelect) {
        function actualizarClaseAccidente() {
            mostrarOcultarContenedor('#otro_clase_accidente_container', 
                claseAccidenteSelect.value === 'OTRO');
        }
        
        claseAccidenteSelect.addEventListener('change', actualizarClaseAccidente);
        actualizarClaseAccidente();
    }
    
    // ===========================================================
    // 4. MANEJO DE CHOQUE CON OBJETO FIJO
    // ===========================================================
    const choqueConSelect = document.getElementById('id_choque_con');
    const objetoFijoSelect = document.getElementById('id_objeto_fijo');
    
    if (choqueConSelect) {
        function actualizarChoqueCon() {
            const esObjetoFijo = choqueConSelect.value === 'OBJETO FIJO';
            mostrarOcultarContenedor('#objeto_fijo_container', esObjetoFijo);
            
            if (!esObjetoFijo) {
                mostrarOcultarContenedor('#otro_objeto_fijo_container', false);
            } else if (objetoFijoSelect) {
                actualizarObjetoFijo();
            }
        }
        
        choqueConSelect.addEventListener('change', actualizarChoqueCon);
        actualizarChoqueCon();
    }
    
    if (objetoFijoSelect) {
        function actualizarObjetoFijo() {
            mostrarOcultarContenedor('#otro_objeto_fijo_container', 
                objetoFijoSelect.value === 'OTRO');
        }
        
        objetoFijoSelect.addEventListener('change', actualizarObjetoFijo);
        actualizarObjetoFijo();
    }
    
    // ===========================================================
    // 5. FUNCIONES DE INICIALIZACIÓN Y GESTIÓN DE VEHÍCULOS
    // ===========================================================
    
    // Para actualizar la numeración de vehículos visibles
    function renumerarVehiculos() {
        const vehiculos = document.querySelectorAll('.vehiculo-form:not([style*="display: none"])');
        vehiculos.forEach((vehiculo, index) => {
            const titulo = vehiculo.querySelector('h5');
            if (titulo) titulo.textContent = `Vehículo #${index + 1}`;
        });
    }
    
    // Para actualizar el contador total de vehículos
    function actualizarTotalVehiculos() {
        const totalInput = document.getElementById('id_total_vehiculos_involucrados');
        if (totalInput) {
            const cantidad = document.querySelectorAll('.vehiculo-form:not([style*="display: none"])').length;
            totalInput.value = cantidad;
        }
    }
    
    // Para inicializar todos los eventos de un formulario de vehículo
    function inicializarFormularioVehiculo(formulario) {
        console.log(`Inicializando formulario: ${formulario.id}`);
        
        // 1. EMBRIAGUEZ DEL CONDUCTOR
        const selectEmbriaguez = formulario.querySelector('[id$="-embriaguez_conductor"]');
        const contenedorGrado = formulario.querySelector('.embriaguez_grado_container');
        
        if (selectEmbriaguez && contenedorGrado) {
            function actualizarEmbriaguez() {
                const valor = selectEmbriaguez.value || '';
                const esSi = valor.toUpperCase() === 'SI' || valor.toUpperCase() === 'SÍ';
                
                contenedorGrado.style.display = esSi ? 'block' : 'none';
                console.log(`Embriaguez ${selectEmbriaguez.id}: "${valor}" - Mostrar grado: ${esSi}`);
                
                // Forzar visibilidad del contenedor (debugging)
                if (esSi && window.getComputedStyle(contenedorGrado).display === 'none') {
                    console.warn('Forzando visibilidad del contenedor de grado de embriaguez');
                    contenedorGrado.style.display = 'block !important';
                    contenedorGrado.setAttribute('style', 'display: block !important');
                }
            }
            
            selectEmbriaguez.addEventListener('change', actualizarEmbriaguez);
            
            // Forzar inicialización inmediata
            setTimeout(actualizarEmbriaguez, 100);
        } else {
            console.warn(`Falta selector de embriaguez o contenedor de grado en ${formulario.id}`);
            if (selectEmbriaguez) console.log('Valor de embriaguez:', selectEmbriaguez.value);
        }
        
        // 2. NÚMERO DE HERIDOS
        const inputHeridos = formulario.querySelector('[id$="-numero_heridos"]');
        const contenedorHeridos = formulario.querySelector('.heridos_fallece_container');
        
        if (inputHeridos && contenedorHeridos) {
            function actualizarHeridos() {
                const cantidad = parseInt(inputHeridos.value) || 0;
                contenedorHeridos.style.display = cantidad > 0 ? 'block' : 'none';
                console.log(`Heridos ${inputHeridos.id}: ${cantidad} - Mostrar: ${cantidad > 0}`);
                
                // Forzar visibilidad (debugging)
                if (cantidad > 0 && window.getComputedStyle(contenedorHeridos).display === 'none') {
                    console.warn('Forzando visibilidad del contenedor de heridos');
                    contenedorHeridos.setAttribute('style', 'display: block !important');
                }
            }
            
            inputHeridos.addEventListener('change', actualizarHeridos);
            inputHeridos.addEventListener('input', actualizarHeridos);
            inputHeridos.addEventListener('keyup', actualizarHeridos);
            
            // Forzar inicialización inmediata
            setTimeout(actualizarHeridos, 100);
        } else {
            console.warn(`Falta input de heridos o contenedor en ${formulario.id}`);
        }
        
        // 3. NÚMERO DE FALLECIDOS
        const inputFallecidos = formulario.querySelector('[id$="-numero_fallecidos"]');
        const contenedorFallecidos = formulario.querySelector('.fallecidos_container');
        const formulariosFallecidos = formulario.querySelector('.fallecidos_forms');
        
        if (inputFallecidos && contenedorFallecidos) {
            function actualizarFallecidos() {
                const cantidad = parseInt(inputFallecidos.value) || 0;
                contenedorFallecidos.style.display = cantidad > 0 ? 'block' : 'none';
                console.log(`Fallecidos ${inputFallecidos.id}: ${cantidad} - Mostrar: ${cantidad > 0}`);
                
                // Crear formularios de fallecidos si es necesario
                if (cantidad > 0 && formulariosFallecidos) {
                    formulariosFallecidos.innerHTML = '';
                    const formIndex = inputFallecidos.id.match(/\d+/) ? inputFallecidos.id.match(/\d+/)[0] : '0';
                    
                    for (let i = 1; i <= cantidad; i++) {
                        formulariosFallecidos.innerHTML += `
                            <div class="fallecido-form border rounded p-3 mt-2">
                                <h6>Fallecido #${i}</h6>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label for="fallecido_${formIndex}_${i}_nombre" class="form-label">Nombre y Apellidos:</label>
                                        <input type="text" class="form-control" id="fallecido_${formIndex}_${i}_nombre" 
                                               name="fallecidos[${formIndex}][${i}][nombre_apellidos]" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label for="fallecido_${formIndex}_${i}_direccion" class="form-label">Dirección:</label>
                                        <input type="text" class="form-control" id="fallecido_${formIndex}_${i}_direccion" 
                                               name="fallecidos[${formIndex}][${i}][direccion]" required>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }
                
                // Forzar visibilidad (debugging)
                if (cantidad > 0 && window.getComputedStyle(contenedorFallecidos).display === 'none') {
                    console.warn('Forzando visibilidad del contenedor de fallecidos');
                    contenedorFallecidos.setAttribute('style', 'display: block !important');
                }
            }
            
            inputFallecidos.addEventListener('change', actualizarFallecidos);
            inputFallecidos.addEventListener('input', actualizarFallecidos);
            inputFallecidos.addEventListener('keyup', actualizarFallecidos);
            
            // Forzar inicialización inmediata
            setTimeout(actualizarFallecidos, 100);
        } else {
            console.warn(`Falta input de fallecidos o contenedor en ${formulario.id}`);
        }
        
        // 4. BOTÓN ELIMINAR VEHÍCULO
        const botonEliminar = formulario.querySelector('.eliminar-vehiculo');
        if (botonEliminar) {
            botonEliminar.addEventListener('click', function() {
                const formIndex = formulario.id.replace('vehiculo_', '');
                
                // Marcar para eliminar
                const deleteCheckbox = document.getElementById(`id_vehiculo_set-${formIndex}-DELETE`);
                if (deleteCheckbox) deleteCheckbox.checked = true;
                
                // Ocultar formulario
                formulario.style.display = 'none';
                
                // Actualizar contadores y renumerar
                actualizarTotalVehiculos();
                renumerarVehiculos();
            });
        }
    }
    
    // Inicializar todos los formularios existentes
    document.querySelectorAll('.vehiculo-form').forEach(formulario => {
        inicializarFormularioVehiculo(formulario);
    });
    
    // Configurar botón agregar vehículo
    const botonAgregar = document.getElementById('agregar_vehiculo_btn');
    if (botonAgregar) {
        botonAgregar.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Elementos necesarios
            const formsetContainer = document.getElementById('vehiculos_formset');
            const totalFormsInput = document.querySelector('input[name$="TOTAL_FORMS"]');
            
            if (!formsetContainer || !totalFormsInput) {
                console.error('No se encontraron elementos esenciales');
                return;
            }
            
            // Verificar límite
            const visibleCount = document.querySelectorAll('.vehiculo-form:not([style*="display: none"])').length;
            if (visibleCount >= 10) {
                alert('No se pueden agregar más de 10 vehículos.');
                return;
            }
            
            // Obtener plantilla base
            const firstForm = document.querySelector('.vehiculo-form');
            if (!firstForm) {
                console.error('No se encontró formulario base');
                return;
            }
            
            // Calcular nuevo índice
            const formCount = parseInt(totalFormsInput.value);
            
            // Clonar y configurar
            const newForm = firstForm.cloneNode(true);
            newForm.id = `vehiculo_${formCount}`;
            
            // Actualizar índices
            newForm.innerHTML = newForm.innerHTML
                .replace(/vehiculo_set-0-/g, `vehiculo_set-${formCount}-`)
                .replace(/id_vehiculo_set-0-/g, `id_vehiculo_set-${formCount}-`);
            
            // Limpiar valores
            newForm.querySelectorAll('input, select, textarea').forEach(field => {
                if (field.type === 'checkbox') {
                    field.checked = false;
                } else if (field.type === 'number') {
                    field.value = '0';
                } else if (field.tagName === 'SELECT') {
                    field.selectedIndex = 0;
                } else {
                    field.value = '';
                }
            });
            
            // Ocultar contenedores específicos
            newForm.querySelectorAll('.fallecidos_container, .heridos_fallece_container, .embriaguez_grado_container').forEach(container => {
                container.style.display = 'none';
            });
            
            // Limpiar fallecidos
            const fallecidosForms = newForm.querySelector('.fallecidos_forms');
            if (fallecidosForms) fallecidosForms.innerHTML = '';
            
            // Añadir al formulario
            formsetContainer.appendChild(newForm);
            
            // Actualizar contadores
            totalFormsInput.value = formCount + 1;
            
            // Inicializar eventos
            inicializarFormularioVehiculo(newForm);
            
            // Actualizar contadores y renumerar
            actualizarTotalVehiculos();
            renumerarVehiculos();
        });
    }
    
    // ===========================================================
    // 6. CONVERSIÓN DE INPUTS A SELECTORES (OPCIONAL)
    // ===========================================================
    
    // Si quieres convertir los inputs numéricos en selectores
    function convertirInputASelect(inputId, maxValue) {
        const input = document.getElementById(inputId);
        if (!input) return;
        
        // Crear opciones (0 a maxValue)
        const opciones = [];
        for (let i = 0; i <= maxValue; i++) {
            opciones.push(`<option value="${i}">${i}</option>`);
        }
        
        // Crear select
        const select = document.createElement('select');
        select.className = input.className;
        select.id = input.id;
        select.name = input.name;
        select.innerHTML = opciones.join('');
        
        // Reemplazar
        input.parentNode.replaceChild(select, input);
        
        // Añadir evento
        select.addEventListener('change', function() {
            // Disparar evento change
            const event = new Event('change');
            select.dispatchEvent(event);
        });
        
        return select;
    }
    
    // Comentar estas líneas para no convertir a select
    /*
    document.querySelectorAll('.vehiculo-form').forEach(form => {
        const heridosId = form.querySelector('[id$="-numero_heridos"]')?.id;
        const fallecidosId = form.querySelector('[id$="-numero_fallecidos"]')?.id;
        
        if (heridosId) convertirInputASelect(heridosId, 10);
        if (fallecidosId) convertirInputASelect(fallecidosId, 10);
    });
    */
    
    console.log('Inicialización completada');
});
</script>
{% endblock %}